<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o Bateria 12.7 (Final)</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e67e22;
            --success: #27ae60;
            --danger: #c0392b;
            --info: #2980b9;
            --light: #f8f9fa;
            --dark: #343a40;
            --card-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background-color: #eef2f3;
            color: var(--dark);
            padding-bottom: 50px;
        }

        /* --- Global Loading Indicator --- */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(44, 62, 80, 0.95);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 1.2rem;
            text-align: center;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


        /* --- Navega√ß√£o --- */
        .compact-menu {
            background-color: var(--primary);
            padding: 10px 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
        }

        #menu-toggle {
            background: none;
            color: white;
            border: none;
            padding: 10px;
            font-size: 1.4rem;
            cursor: pointer;
            transition: 0.2s;
            border-radius: 5px;
        }
        #menu-toggle:hover {
            background: rgba(255,255,255,0.1);
        }

        #nav-buttons-container {
            position: absolute;
            top: 55px;
            right: 15px;
            width: 200px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            overflow: hidden;
            max-height: 0; 
            opacity: 0;
            visibility: hidden;
            transition: max-height 0.4s ease-in-out, opacity 0.4s, visibility 0.4s;
            padding: 0;
            border: 1px solid #eee;
        }

        #nav-buttons-container.collapsed {
            max-height: 500px;
            opacity: 1;
            visibility: visible;
            padding: 10px;
        }

        .compact-menu .menu-btn {
            background: #f8f9fa;
            border: none;
            color: var(--dark);
            padding: 12px 15px;
            cursor: pointer;
            font-weight: 600;
            border-radius: 8px;
            transition: 0.2s;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            width: 100%; 
            margin-top: 5px; 
            text-align: left; 
        }

        .compact-menu .menu-btn i {
            margin-right: 10px;
            color: var(--accent);
            min-width: 20px;
        }
        
        .compact-menu .menu-btn:first-child { margin-top: 0; }
        .compact-menu .menu-btn:hover { background-color: #e9ecef; }
        .compact-menu .menu-btn.active {
            background-color: var(--accent);
            color: white;
            font-weight: 700;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .compact-menu .menu-btn.active i { color: white; }

        /* --- Layout --- */
        .container {
            max-width: 1000px;
            margin: 20px auto; 
            padding: 0 15px;
        }

        .tab-content { display: none; animation: slideUp 0.4s; }
        .tab-content.active { 
            display: block; 
            border-left: 5px solid var(--accent); 
            padding-left: 10px;
            margin-left: -15px;
            padding-right: 5px;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0.5; } to { opacity: 1; } }

        h2 { color: var(--primary); margin-bottom: 15px; padding: 0; }

        /* --- Bot√µes e Inputs --- */
        .btn-primary {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 4px 0 #d35400;
            transition: 0.2s;
            margin-top: 20px;
        }
        .btn-primary:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-info {
            background-color: var(--info);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: 0.2s;
        }
        .btn-info:hover { background-color: #20638f; }
        .btn-next { background-color: var(--info); box-shadow: 0 4px 0 #20638f; }

        input:not(.edit-form-container input), 
        select:not(.edit-form-container select) { 
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; 
        }

        /* --- Filtros --- */
        .church-selector { 
            display: flex; gap: 10px; margin-bottom: 20px; 
            background: white; padding: 10px; border-radius: 10px; box-shadow: var(--card-shadow);
        }
        .church-btn {
            flex: 1; padding: 15px 10px; background: #f8f9fa; border: 1px solid #e0e0e0;
            border-radius: 8px; cursor: pointer; font-weight: bold; color: #777;
            display: flex; flex-direction: column; align-items: center; font-size: 0.9rem;
        }
        .church-btn i { font-size: 1.5rem; margin-bottom: 5px; }
        .church-btn.selected { 
            border-color: var(--accent); color: var(--accent); background: #fff5eb; box-shadow: 0 0 5px rgba(230, 126, 34, 0.4);
        }

        /* --- Cards --- */
        .student-card {
            background: white; padding: 15px; border-radius: 10px; margin-bottom: 12px; box-shadow: var(--card-shadow); display: flex; flex-direction: column; gap: 10px;
        }
        .student-header { display: flex; justify-content: space-between; align-items: center; }
        .student-name { font-size: 1.1rem; font-weight: 700; color: var(--primary); }
        .btn-group { display: flex; gap: 5px; }
        .option-btn {
            flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px;
            background: #fff; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s;
        }
        .opt-p.active { background: var(--success); color: white; border-color: var(--success); }
        .opt-f.active { background: var(--danger); color: white; border-color: var(--danger); }
        .opt-j.active { background: var(--info); color: white; border-color: var(--info); }
        .opt-mb.active { background: #27ae60; color: white; }
        .opt-b.active { background: #2980b9; color: white; }
        .opt-r.active { background: #f39c12; color: white; }
        .opt-ru.active { background: #c0392b; color: white; }

        /* --- Formul√°rio Retr√°til --- */
        .edit-form-container {
            max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out, padding 0.4s;
            padding: 0 5px; border-top: 1px solid #eee; margin-top: 10px;
        }
        .edit-form-container.open { max-height: 500px; padding: 15px 5px; }
        .edit-form-container input, .edit-form-container select {
            margin-bottom: 8px; padding: 8px; font-size: 0.9rem; width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px;
        }
        .edit-form-container label { font-size: 0.8rem; font-weight: 600; display: block; margin-top: 5px; color: var(--primary); }
        .btn-save-edit {
            background-color: var(--success); color: white; border: none; padding: 10px; border-radius: 5px;
            cursor: pointer; width: 100%; margin-top: 10px; font-weight: 600;
        }

        /* --- Tabelas e Relat√≥rios --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .group-column { background: white; border-radius: 10px; overflow: hidden; min-height: 200px; }
        .group-header { font-weight: 700; text-transform: uppercase; padding: 15px; text-align: center; color: white; }
        .header-mb { background: #27ae60; } .header-b { background: #2980b9; } .header-r { background: #f39c12; } .header-ru { background: #c0392b; }
        .group-content { padding: 15px; }
        .group-card-mini { background: var(--light); padding: 12px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; border-left: 5px solid; }
        .badge-avg { font-weight: 700; padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.9rem; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--primary); color: white; }
        .row-alert { background-color: #fadbd8; }
        
        .details-row td { padding: 15px; background: #f9f9f9; border-bottom: 3px solid var(--accent); }
        .details-row table { margin-top: 10px; font-size: 0.85rem; }
        .details-row th { background: #e0e0e0; color: #333; }

        /* --- Footer --- */
        #connection-status {
            position: fixed; bottom: 0; left: 0; width: 100%; padding: 8px; text-align: center;
            font-size: 0.8rem; color: white; background-color: var(--primary); z-index: 500;
        }
        #connection-status.connected { background-color: var(--success); }
        #connection-status.error { background-color: var(--danger); }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <p>Conectando ao Firebase...</p>
        <p id="auth-status-display" style="font-size:0.9rem; margin-top:5px;">Aguarde...</p>
        <button onclick="document.getElementById('loading-overlay').style.display='none'" 
                style="margin-top:20px; padding:10px; background:transparent; border:1px solid white; color:white; border-radius:5px; cursor:pointer;">
            Fechar Carregamento (For√ßar)
        </button>
    </div>

    <nav class="compact-menu">
        <span class="app-title">ü•Å Gest√£o Bateria</span>
        <button id="menu-toggle" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
        
        <div id="nav-buttons-container" class="collapsed">
            <button onclick="showTab('chamada')" class="menu-btn active" id="nav-chamada"><i class="fas fa-check-square"></i> 1. Chamada</button>
            <button onclick="showTab('avaliacao')" class="menu-btn" id="nav-avaliacao"><i class="fas fa-star"></i> 2. Avalia√ß√£o</button>
            <button onclick="showTab('relatorio')" class="menu-btn" id="nav-relatorio"><i class="fas fa-trophy"></i> Grupos</button>
            <button onclick="showTab('historico')" class="menu-btn" id="nav-historico"><i class="fas fa-chart-line"></i> Hist√≥rico</button>
            <button onclick="showTab('cadastro')" class="menu-btn" id="nav-cadastro"><i class="fas fa-user-plus"></i> 4. Cadastro</button>
            <button onclick="showTab('gestao')" class="menu-btn" id="nav-gestao"><i class="fas fa-edit"></i> 5. Gest√£o</button>
        </div>
    </nav>
    
    <div class="container">

        <div id="chamada" class="tab-content active">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Passo 1: Chamada</h2>
                <input type="date" id="dataAtual" style="width: auto; padding: 5px;">
            </div>
            <div class="church-selector">
                <button class="church-btn" onclick="filterChurchCall('Vila Ildemar', this)"><i class="fas fa-house"></i> Vila Ildemar</button>
                <button class="church-btn" onclick="filterChurchCall('Centro', this)"><i class="fas fa-building"></i> Centro</button>
            </div>
            <div id="chamada-list">
                <p style="text-align: center; color: #777; margin-top: 30px;">Selecione uma igreja acima.</p>
            </div>
            <button class="btn-primary btn-next" onclick="goToEvaluation()">PR√ìXIMO: AVALIAR ‚ûî</button>
        </div>

        <div id="avaliacao" class="tab-content">
            <h2>Passo 2: Avaliar</h2>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">Mostrando apenas alunos com <b>PRESEN√áA</b>.</p>
            <div id="avaliacao-list"></div>
            <button class="btn-primary" style="background-color: var(--success);" onclick="saveAllData()">üíæ FINALIZAR AULA</button>
        </div>

        <div id="relatorio" class="tab-content">
            <h2>Grupos por N√≠vel</h2>
            <div style="margin-bottom: 15px;">
                <label>Filtrar por Igreja:</label>
                <select id="filterReportChurch" onchange="renderGroups()" style="width: auto; min-width: 200px;">
                    <option value="todos">Todas as Igrejas</option>
                    <option value="Vila Ildemar">Vila Ildemar</option>
                    <option value="Centro">Centro</option>
                </select>
            </div>
            <div class="dashboard-grid">
                <div class="group-column"><div class="group-header header-mb">üíé Destaques (9.0+)</div><div id="group-mb" class="group-content"></div></div>
                <div class="group-column"><div class="group-header header-b">üöÄ Bom Ritmo (7.0-8.9)</div><div id="group-b" class="group-content"></div></div>
                <div class="group-column"><div class="group-header header-r">üî® Em Evolu√ß√£o (5.0-6.9)</div><div id="group-r" class="group-content"></div></div>
                <div class="group-column"><div class="group-header header-ru">‚ö†Ô∏è Aten√ß√£o (< 5.0)</div><div id="group-ru" class="group-content"></div></div>
            </div>
        </div>

        <div id="historico" class="tab-content">
            <h2>Hist√≥rico</h2>
            <div class="filter-row" style="margin-bottom: 15px; display:flex; gap:10px; flex-wrap:wrap;">
                <input type="text" id="searchHistory" placeholder="Buscar aluno..." onkeyup="renderHistory()" style="flex:1;">
                <select id="filterHistoryChurch" onchange="renderHistory()" style="flex:1;">
                    <option value="todos">Todas</option>
                    <option value="Vila Ildemar">Vila Ildemar</option>
                    <option value="Centro">Centro</option>
                </select>
                <label style="display:flex; align-items:center; background:white; padding:0 10px; border-radius:8px;">
                    <input type="checkbox" id="sortDesc" onchange="renderHistory()" style="width:auto; margin-right:5px;"> Ordenar Faltas
                </label>
            </div>
            <table>
                <thead><tr><th>Nome</th><th>Igreja</th><th>Idade</th><th>Faltas</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                <tbody id="history-body"></tbody>
            </table>
        </div>

        <div id="cadastro" class="tab-content">
            <h2>Cadastrar Aluno</h2>
            <form onsubmit="registerStudent(event)">
                <label>Nome:</label><input type="text" id="reg-name" required>
                <label>Idade:</label><input type="number" id="reg-age" required>
                <label>Sexo:</label><select id="reg-sex" required><option value="M">Masculino</option><option value="F">Feminino</option></select>
                <label>Igreja:</label><select id="reg-church"><option value="Vila Ildemar">Vila Ildemar</option><option value="Centro">Centro</option></select>
                <button type="submit" class="btn-primary">Salvar Cadastro</button>
            </form>
        </div>

        <div id="gestao" class="tab-content">
            <h2>Gest√£o e Edi√ß√£o</h2>
            <input type="text" id="searchManage" placeholder="Buscar aluno para editar..." onkeyup="renderManageList()">
            <div id="manage-list" style="margin-top:20px;">
                <p style="text-align: center; color: #777;">Use a busca acima.</p>
            </div>
        </div>

    </div>
    
    <div id="connection-status">Aguardando...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, doc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBi28c7g2ShKrmJCpfIOnpjsXunqZv5KGI",
            authDomain: "aula-de-bateria.firebaseapp.com",
            projectId: "aula-de-bateria",
            storageBucket: "aula-de-bateria.firebasestorage.app",
            messagingSenderId: "759017864636",
            appId: "1:759017864636:web:d45a5bb698355de6753fb9",
            measurementId: "G-973PF3KL86"
        };

        let students = [], sessionData = {}, currentChurchFilter = '';
        let db, auth, studentCollectionRef, sessionCollectionRef;

        // TRAVA DE SEGURAN√áA: Se em 5 segundos n√£o carregar, libera a tela
        setTimeout(() => {
            const overlay = document.getElementById('loading-overlay');
            if(overlay && overlay.style.display !== 'none') {
                overlay.style.display = 'none';
                console.warn("Overlay ocultado for√ßosamente pelo timeout.");
            }
        }, 5000);

        function setConnectionStatus(msg, type = '') {
            const el = document.getElementById('connection-status');
            if(el) { el.textContent = msg; el.className = type; }
        }

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);

                studentCollectionRef = collection(db, 'students_public');
                sessionCollectionRef = collection(db, 'session_data');

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setConnectionStatus('Conectado.', 'connected');
                        document.getElementById('loading-overlay').style.display = 'none';
                        startListeners();
                    } else {
                        setConnectionStatus('Desconectado.', 'error');
                        // Garante que o overlay saia mesmo desconectado para permitir retry se houver l√≥gica
                         document.getElementById('loading-overlay').style.display = 'none';
                    }
                });
            } catch (e) {
                console.error(e);
                alert("Erro ao conectar: " + e.message);
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        function startListeners() {
            onSnapshot(doc(sessionCollectionRef, 'current_class'), (snap) => {
                if (snap.exists()) sessionData = snap.data();
                updateUI();
            });

            onSnapshot(studentCollectionRef, (snap) => {
                students = [];
                snap.forEach(d => {
                    const dt = d.data();
                    students.push({ id: d.id, ...dt, isActive: dt.hasOwnProperty('isActive') ? dt.isActive : true });
                });
                updateUI();
            });
        }

        function updateUI() {
            const tab = document.querySelector('.tab-content.active');
            if (!tab) return;
            if (tab.id === 'chamada') renderCallList();
            else if (tab.id === 'avaliacao') renderEvalList();
            else if (tab.id === 'relatorio') renderGroups();
            else if (tab.id === 'historico') renderHistory();
            else if (tab.id === 'gestao') renderManageList();
        }

        // --- EXPOSED FUNCTIONS ---

        window.toggleMenu = () => document.getElementById('nav-buttons-container').classList.toggle('collapsed');
        
        window.showTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('nav-'+id).classList.add('active');
            document.getElementById('nav-buttons-container').classList.remove('collapsed');
            updateUI();
        };

        window.filterChurchCall = (church, btn) => {
            currentChurchFilter = church;
            document.querySelectorAll('.church-btn').forEach(b => b.classList.remove('selected'));
            if(btn) btn.classList.add('selected');
            renderCallList();
        };

        window.renderCallList = () => {
            const list = document.getElementById('chamada-list');
            list.innerHTML = '';
            if(!currentChurchFilter) return list.innerHTML = '<p style="text-align:center;padding:20px;">Selecione uma igreja.</p>';
            
            const filtered = students.filter(s => s.church === currentChurchFilter && s.isActive);
            if(filtered.length === 0) return list.innerHTML = '<p style="text-align:center;padding:20px;">Nenhum aluno ativo.</p>';

            filtered.forEach(s => {
                const st = sessionData[s.id]?.status || '';
                const div = document.createElement('div');
                div.className = 'student-card';
                div.innerHTML = `
                    <div class="student-header"><span class="student-name">${s.name}</span></div>
                    <div class="btn-group">
                        <button class="option-btn opt-p ${st==='P'?'active':''}" onclick="setSession('${s.id}','status','P')">PRESENTE</button>
                        <button class="option-btn opt-f ${st==='F'?'active':''}" onclick="setSession('${s.id}','status','F')">FALTA</button>
                        <button class="option-btn opt-j ${st==='J'?'active':''}" onclick="setSession('${s.id}','status','J')">JUSTIFICADA</button>
                    </div>`;
                list.appendChild(div);
            });
        };

        window.setSession = async (id, field, val) => {
            if(!sessionData[id]) sessionData[id] = {};
            sessionData[id][field] = val;
            await setDoc(doc(sessionCollectionRef, 'current_class'), sessionData, { merge: true });
        };

        window.goToEvaluation = () => {
            if(!Object.values(sessionData).some(d=>d.status==='P')) return alert('Marque presen√ßa primeiro.');
            window.showTab('avaliacao');
        };

        window.renderEvalList = () => {
            const list = document.getElementById('avaliacao-list');
            list.innerHTML = '';
            const filtered = students.filter(s => s.church === currentChurchFilter && sessionData[s.id]?.status === 'P');
            if(filtered.length === 0) return list.innerHTML = '<p>Ningu√©m presente.</p>';

            filtered.forEach(s => {
                const p = sessionData[s.id]?.perf || '';
                const div = document.createElement('div');
                div.className = 'student-card';
                div.innerHTML = `
                    <div class="student-header"><span class="student-name">${s.name}</span></div>
                    <div class="btn-group">
                        <button class="option-btn opt-mb ${p==='MB'?'active':''}" onclick="setSession('${s.id}','perf','MB')">MUITO BOM</button>
                        <button class="option-btn opt-b ${p==='B'?'active':''}" onclick="setSession('${s.id}','perf','B')">BOM</button>
                        <button class="option-btn opt-r ${p==='R'?'active':''}" onclick="setSession('${s.id}','perf','R')">REGULAR</button>
                        <button class="option-btn opt-ru ${p==='Ru'?'active':''}" onclick="setSession('${s.id}','perf','Ru')">RUIM</button>
                    </div>`;
                list.appendChild(div);
            });
        };

        window.saveAllData = async () => {
            const date = document.getElementById('dataAtual').value || new Date().toISOString().split('T')[0];
            let batch = [];
            for(const [id, data] of Object.entries(sessionData)) {
                const s = students.find(st => st.id === id);
                if(s && data.status) {
                    const entry = { date: date, status: data.status, performance: data.status==='P' ? (data.perf||'N/A') : 'N/A' };
                    const hist = [...(s.history||[]), entry];
                    batch.push(updateDoc(doc(studentCollectionRef, id), { history: hist }));
                }
            }
            if(batch.length === 0) return alert("Nada para salvar.");
            await Promise.all(batch);
            await setDoc(doc(sessionCollectionRef, 'current_class'), {});
            alert("Salvo!");
            sessionData = {};
            window.showTab('chamada');
        };

        window.registerStudent = async (e) => {
            e.preventDefault();
            await addDoc(studentCollectionRef, {
                name: document.getElementById('reg-name').value,
                age: parseInt(document.getElementById('reg-age').value),
                sex: document.getElementById('reg-sex').value,
                church: document.getElementById('reg-church').value,
                history: [], isActive: true
            });
            alert('Cadastrado!'); e.target.reset();
        };

        // --- GEST√ÉO E EDI√á√ÉO ---

        window.renderManageList = () => {
            const list = document.getElementById('manage-list');
            list.innerHTML = '';
            const term = document.getElementById('searchManage').value.toLowerCase();
            const filtered = students.filter(s => s.name.toLowerCase().includes(term));

            if(filtered.length === 0) return list.innerHTML = '<p style="text-align:center;">Nenhum aluno.</p>';

            filtered.forEach(s => {
                const statusColor = s.isActive ? 'var(--success)' : 'var(--danger)';
                const statusText = s.isActive ? 'Ativo' : 'Inativo';
                
                const div = document.createElement('div');
                div.className = 'student-card';
                div.innerHTML = `
                    <div class="student-header">
                        <span class="student-name">${s.name}</span>
                        <span class="badge-avg" style="background:${statusColor}">${statusText}</span>
                    </div>
                    <div class="btn-group" style="margin-top:10px;">
                        <button class="btn-info" onclick="toggleEditForm('${s.id}', this)">Editar Dados</button>
                        <button class="option-btn ${s.isActive ? 'opt-f' : 'opt-p'}" onclick="toggleStatus('${s.id}', ${s.isActive})">
                            ${s.isActive ? 'Inativar' : 'Reativar'}
                        </button>
                    </div>
                    <div id="edit-form-${s.id}" class="edit-form-container">
                        <form onsubmit="submitEdit(event, '${s.id}')">
                            <label>Nome:</label><input type="text" id="ed-name-${s.id}" value="${s.name}" required>
                            <label>Idade:</label><input type="number" id="ed-age-${s.id}" value="${s.age}" required>
                            <label>Sexo:</label><select id="ed-sex-${s.id}"><option value="M">M</option><option value="F">F</option></select>
                            <label>Igreja:</label><select id="ed-church-${s.id}"><option value="Vila Ildemar">Vila Ildemar</option><option value="Centro">Centro</option></select>
                            <button type="submit" class="btn-save-edit">SALVAR</button>
                        </form>
                    </div>
                `;
                list.appendChild(div);
                // Pr√©-selecionar selects
                document.getElementById(`ed-sex-${s.id}`).value = s.sex;
                document.getElementById(`ed-church-${s.id}`).value = s.church;
            });
        };

        window.toggleEditForm = (id, btn) => {
            const form = document.getElementById(`edit-form-${id}`);
            const isOpen = form.classList.contains('open');
            document.querySelectorAll('.edit-form-container').forEach(f => f.classList.remove('open'));
            document.querySelectorAll('.btn-info').forEach(b => { if(b.textContent === 'Fechar Edi√ß√£o') b.textContent = 'Editar Dados'; });
            
            if(!isOpen) {
                form.classList.add('open');
                btn.textContent = 'Fechar Edi√ß√£o';
            } else {
                btn.textContent = 'Editar Dados';
            }
        };

        window.submitEdit = async (e, id) => {
            e.preventDefault();
            await updateDoc(doc(studentCollectionRef, id), {
                name: document.getElementById(`ed-name-${id}`).value,
                age: parseInt(document.getElementById(`ed-age-${id}`).value),
                sex: document.getElementById(`ed-sex-${id}`).value,
                church: document.getElementById(`ed-church-${id}`).value
            });
            alert('Atualizado!');
            renderManageList(); // Recarrega para fechar o form
        };

        window.toggleStatus = async (id, current) => {
            if(confirm('Tem certeza?')) {
                await updateDoc(doc(studentCollectionRef, id), { isActive: !current });
            }
        };

        // --- RELAT√ìRIOS E HIST√ìRICO ---
        
        window.renderGroups = () => {
            const scores = { 'MB': 10, 'B': 7.5, 'R': 5, 'Ru': 2.5 };
            const filter = document.getElementById('filterReportChurch').value;
            let groups = { mb:[], b:[], r:[], ru:[] };
            
            students.filter(s => s.isActive && (filter === 'todos' || s.church === filter)).forEach(s => {
                let total=0, count=0;
                (s.history||[]).forEach(h => { if(scores[h.performance]) { total+=scores[h.performance]; count++; }});
                if(count === 0) return;
                let avg = total/count;
                let html = `<div class="group-card-mini"><span>${s.name}</span><span class="badge-avg" style="background:#555">${avg.toFixed(1)}</span></div>`;
                
                if(avg >= 9) groups.mb.push(html);
                else if(avg >= 7) groups.b.push(html);
                else if(avg >= 5) groups.r.push(html);
                else groups.ru.push(html);
            });

            document.getElementById('group-mb').innerHTML = groups.mb.join('') || '<p style="text-align:center;color:#ccc">Vazio</p>';
            document.getElementById('group-b').innerHTML = groups.b.join('') || '<p style="text-align:center;color:#ccc">Vazio</p>';
            document.getElementById('group-r').innerHTML = groups.r.join('') || '<p style="text-align:center;color:#ccc">Vazio</p>';
            document.getElementById('group-ru').innerHTML = groups.ru.join('') || '<p style="text-align:center;color:#ccc">Vazio</p>';
        };

        window.renderHistory = () => {
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = '';
            const term = document.getElementById('searchHistory').value.toLowerCase();
            const church = document.getElementById('filterHistoryChurch').value;
            const sort = document.getElementById('sortDesc').checked;

            let list = students.map(s => {
                let faltas = (s.history||[]).filter(h => h.status === 'F').length;
                return { ...s, faltas };
            }).filter(s => s.name.toLowerCase().includes(term) && (church === 'todos' || s.church === church));

            if(sort) list.sort((a,b) => b.faltas - a.faltas);

            list.forEach(s => {
                const tr = document.createElement('tr');
                if(s.faltas >= 2) tr.className = 'row-alert';
                const statusIcon = s.isActive ? '<i class="fas fa-check" style="color:var(--success)"></i>' : '<i class="fas fa-times" style="color:var(--danger)"></i>';
                tr.innerHTML = `<td>${s.name}</td><td>${s.church}</td><td>${s.age}</td><td>${s.faltas}</td><td>${statusIcon}</td><td><button class="btn-info" onclick="toggleDetails('${s.id}', this)">Detalhes</button></td>`;
                tbody.appendChild(tr);
            });
        };

        window.toggleDetails = (id, btn) => {
            const tr = btn.closest('tr');
            if(tr.nextSibling && tr.nextSibling.className === 'details-row') {
                tr.nextSibling.remove();
                btn.textContent = 'Detalhes';
                return;
            }
            const s = students.find(st => st.id === id);
            const hist = (s.history||[]).map(h => `<tr><td>${h.date}</td><td>${h.status}</td><td>${h.performance}</td></tr>`).join('');
            const row = document.createElement('tr');
            row.className = 'details-row';
            row.innerHTML = `<td colspan="6"><table><tr><th>Data</th><th>Status</th><th>Nota</th></tr>${hist || '<tr><td colspan="3">Sem hist√≥rico</td></tr>'}</table></td>`;
            tr.parentNode.insertBefore(row, tr.nextSibling);
            btn.textContent = 'Fechar';
        };

        // START
        const today = document.getElementById('dataAtual');
        if(today) today.valueAsDate = new Date();
        initFirebase();

    </script>
</body>
</html>
